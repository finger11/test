<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>세입자보증금 계산기</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    table, th, td { border: 1px solid gray; border-collapse: collapse; padding: 5px; }
    th { background-color: #f0f0f0; }
    td input, td select { width: 100%; box-sizing: border-box; text-align: right; }
    button { margin: 5px; }
    .small-yes { color: blue; }
    .small-no { color: red; }
  </style>
</head>
<body>

<h2>배당순위 및 배당금 계산기</h2>

<!-- 부동산소재지구분 -->
<h3>부동산소재지구분</h3>
<select id="locationSelect" onchange="updateSmallTenantInfo()"></select>
<div id="smallTenantInfo" style="margin: 10px 0; font-weight: bold;"></div>

<!-- 근저당 -->
<h3>근저당에 관한 내용</h3>
<table id="mortgageTable"><thead><tr><th>근저당권자명</th><th>근저당설정일자</th><th>근저당금액</th></tr></thead><tbody></tbody></table>
<button onclick="addRow('mortgageTable', ['text','date','currency-mortgage'])">근저당 행 추가</button>
<button onclick="removeRow('mortgageTable')">근저당 행 삭제</button>

<!-- 가압류 -->
<h3>가압류에 관한 내용</h3>
<table id="seizureTable"><thead><tr><th>가압류권자명</th><th>가압류접수일자</th><th>가압류금액</th></tr></thead><tbody></tbody></table>
<button onclick="addRow('seizureTable', ['text','date','currency-seizure'])">가압류 행 추가</button>
<button onclick="removeRow('seizureTable')">가압류 행 삭제</button>

<!-- 세입자 -->
<h3>세입자에 관한 내용</h3>
<table id="tenantTable"><thead><tr><th>호실명</th><th>임차인명</th><th>확정일자</th><th>전입신고일자</th><th>점유일자</th><th>보증금</th></tr></thead><tbody></tbody></table>
<button onclick="addRow('tenantTable', ['text','text','date','date','date','currency-deposit'])">세입자 행 추가</button>
<button onclick="removeRow('tenantTable')">세입자 행 삭제</button>

<!-- 예상낙찰금액 -->
<h3>예상낙찰금액</h3>
<input type="text" id="auctionPrice" placeholder="예: 600,000,000" oninput="this.value=formatNumberInput(this.value)">

<!-- 계산하기 버튼 -->
<br><br><button onclick="calculate()">계산하기</button>

<!-- 최우선변제금 배당결과 표 -->
<h3>최우선변제금 배당결과</h3>
<table id="priorityResultTable"><thead><tr><th>임차인명</th><th>소액임차인여부</th><th>최우선변제금</th></tr></thead><tbody></tbody></table>
<div id="priorityRemain" style="margin:10px 0; font-weight:bold;"></div>

<!-- 결과출력 -->
<h3>배당결과</h3><div id="resultArea"></div>

<script src="최우선변제금기준표_11차개정.js"></script>
<script>
function addRow(tableId, types) {
  const tbody=document.getElementById(tableId).querySelector('tbody');
  const row=tbody.insertRow();
  types.forEach(type=>{
    const cell=row.insertCell();
    const input=document.createElement('input');
    if(type.startsWith('currency')){
      input.type='text'; input.inputMode='numeric';
      input.addEventListener('input',()=>input.value=formatNumberInput(input.value));
    } else {
      input.type=type;
      if(tableId==='mortgageTable'&&type==='date') input.addEventListener('change',updateSmallTenantInfo);
    }
    cell.append(input);
  });
}
function removeRow(tableId){
  const tbody=document.getElementById(tableId).querySelector('tbody');
  if(tbody.rows.length) tbody.deleteRow(-1);
  if(tableId==='mortgageTable') updateSmallTenantInfo();
}

function parseNumber(str){return Number(str.replace(/,/g,''))||0;}
function formatNumberInput(val){val=val.replace(/\D/g,'');return val?Number(val).toLocaleString():' ';}

function calculate(){
  const loc=document.getElementById('locationSelect').value;
  // 우선변제권 한도 및 상한 조회
  const mortRows=[...document.querySelectorAll('#mortgageTable tbody tr')];
  let threshold=0, capPriority=0;
  if(mortRows.length){
    const dates=mortRows.map(r=>r.cells[1].querySelector('input').value).filter(d=>d).sort();
    const date=dates[0];
    const applicable=기준표.filter(i=>{const s=new Date(i.시작),e=new Date(i.종료||'9999-12-31'),c=new Date(date);return s<=c&&c<=e;});
    const m=applicable.find(i=>i.지역===loc)||applicable.find(i=>i.지역==='기타지역');
    if(m){ threshold=m.보증금상한; capPriority=m.최우선; }
  }
  // 세입자 수집 및 효력발생일, 소액판별
  const tenants=[];
  document.querySelectorAll('#tenantTable tbody tr').forEach(r=>{
    const h=r.cells[0].querySelector('input').value;
    const n=r.cells[1].querySelector('input').value;
    const dateStrs=[2,3,4].map(i=>r.cells[i].querySelector('input').value).filter(d=>d);
    // 효력발생일: max date + 1일
    const maxDate=new Date(Math.max(...dateStrs.map(d=>new Date(d))));
    const eff=new Date(maxDate.setDate(maxDate.getDate()+1));
    const effStr=eff.toISOString().split('T')[0];
    const dep=parseNumber(r.cells[5].querySelector('input').value);
    const isSmall=threshold>0 && dep<=threshold;
    tenants.push({ name:`${n}(${h})`, deposit:dep, small:isSmall, date:effStr });
  });
  // 최우선변제금 계산
  const auction=parseNumber(document.getElementById('auctionPrice').value);
  const half=auction/2;
  const smallCount=tenants.filter(t=>t.small).length;
  const perShare= smallCount? Math.min(capPriority, half/smallCount) : 0;
  const totalPriorityPaid=perShare*smallCount;
  // 최우선변제금 결과 표
  const prBody=document.querySelector('#priorityResultTable tbody'); prBody.innerHTML='';
  tenants.forEach(t=>{
    const tr=document.createElement('tr');
    const c1=document.createElement('td'); c1.textContent=t.name;
    const c2=document.createElement('td'); c2.innerHTML=t.small?'<span class="small-yes">대상</span>':'<span class="small-no">비대상</span>';
    const c3=document.createElement('td');
    const amt=t.small? Math.min(perShare, t.deposit):0;
    c3.textContent=amt?amt.toLocaleString()+'원':'';
    tr.append(c1,c2,c3); prBody.append(tr);
  });
  // 우선변제 후 잔액 출력
  const remainPriority=auction - totalPriorityPaid;
  document.getElementById('priorityRemain').textContent=`최우선변제금 배당 후 잔액: ${remainPriority.toLocaleString()}원`;
  // 일반배당 풀 계산
  let remain=remainPriority;
  // 권리자 목록 준비
  const creditors=[];
  ['mortgageTable','seizureTable'].forEach(id=> document.querySelectorAll(`#${id} tbody tr`).forEach(r=>{
    const inputs=r.querySelectorAll('input');
    creditors.push({ name:inputs[0].value, amount:parseNumber(inputs[2].value), date:inputs[1].value });
  }));
  // 세입자(일반채권) 배당
  tenants.forEach(t=>{
    creditors.push({ name:t.name, amount:t.deposit, date:t.date });
  });
  // 날짜순 정렬
  creditors.sort((a,b)=>new Date(a.date)-new Date(b.date));
  // 배당결과 테이블 생성
  let html='<table><tr><th>채권순위</th><th>권리자명</th><th>청구금액</th><th>효력발생일</th><th>배당금액</th><th>배당후잔액</th></tr>';
  creditors.forEach((c,i)=>{
    const dist=Math.min(remain,c.amount); remain-=dist;
    html+=`<tr><td>${i+1}</td><td>${c.name}</td><td>${c.amount.toLocaleString()}원</td><td>${c.date}</td><td>${dist.toLocaleString()}원</td><td>${remain.toLocaleString()}원</td></tr>`;
  });
  html+='</table>';
  document.getElementById('resultArea').innerHTML=html;
}

function updateSmallTenantInfo(){
  const loc=document.getElementById('locationSelect').value;
  const date=document.querySelector('#mortgageTable tbody input[type="date"]')?.value;
  const info=document.getElementById('smallTenantInfo');
  if(!loc||!date){ info.textContent=''; return;} 
  const applicable=기준표.filter(i=>{const s=new Date(i.시작),e=new Date(i.종료||'9999-12-31'),c=new Date(date);return s<=c&&c<=e;});
  const m=applicable.find(i=>i.지역===loc)||applicable.find(i=>i.지역==='기타지역');
  info.textContent=m?`${loc} ${date} 기준 소액임차인 한도: ${m.보증금상한.toLocaleString()}원`: '기준 없음';
}
window.onload=function(){
  const sel=document.getElementById('locationSelect');
  [...new Set(기준표.map(i=>i.지역))].sort().forEach(a=>{sel.add(new Option(a,a));});
};
</script>

</body>
</html>
